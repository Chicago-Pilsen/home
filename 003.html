<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>CDL Air Brakes: Pro Speed Quiz</title>
    <style>
      :root {
        --green: #2e7d32;
        --red: #c62828;
        --felt: #1a472a;
        --gold: #ffd700;
        --card-bg: #ffffff;
      }
      body {
        background-color: var(--felt);
        background-image: radial-gradient(circle, #266d3a 0%, #1a472a 100%);
        font-family: "Segoe UI", sans-serif;
        color: white;
        margin: 0;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .screen {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        text-align: center;
      }
      .hidden {
        display: none !important;
      }

      #game-header {
        width: 100%;
        padding: 15px;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: space-around;
        border-bottom: 3px solid var(--gold);
        align-items: center;
      }
      .stat-box {
        font-size: 1.1rem;
        border: 1px solid var(--gold);
        padding: 5px 15px;
        border-radius: 5px;
        background: rgba(0, 0, 0, 0.3);
      }

      /* Main Question Card */
      #question-container {
        margin-top: 20px;
      }
      .q-card {
        width: 500px;
        height: 160px;
        background: var(--card-bg);
        color: #222;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 25px;
        box-sizing: border-box;
        font-size: 1.3rem;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 3px solid #333;
      }

      /* Answer Cards Row */
      #answers-grid {
        display: flex;
        gap: 12px;
        margin-top: 30px;
        justify-content: center;
        width: 98vw;
      }
      .a-card {
        width: 170px;
        height: 210px;
        background: var(--card-bg);
        color: #333;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        box-sizing: border-box;
        font-size: 0.95rem;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        border: 2px solid #555;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        font-weight: 600;
      }
      .a-card:hover {
        transform: translateY(-8px);
        border-color: var(--gold);
      }

      .correct {
        background-color: var(--green) !important;
        color: white !important;
        border-color: white !important;
      }
      .wrong {
        background-color: var(--red) !important;
        color: white !important;
        animation: shake 0.4s;
        border-color: white !important;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-8px);
        }
        75% {
          transform: translateX(8px);
        }
      }

      #timer-bar-container {
        width: 500px;
        height: 12px;
        background: #222;
        border-radius: 6px;
        margin-top: 15px;
        border: 1px solid #555;
      }
      #timer-bar {
        width: 100%;
        height: 100%;
        background: var(--gold);
        transition: width 0.1s linear;
      }

      .gold-btn {
        padding: 15px 50px;
        background: var(--gold);
        border: none;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1.2rem;
        margin-top: 20px;
        box-shadow: 0 4px #b8860b;
        color: #1a472a;
      }
      input[type="text"] {
        padding: 12px;
        border-radius: 8px;
        border: none;
        font-size: 1.1rem;
        width: 250px;
        margin-bottom: 15px;
        text-align: center;
      }

      #top-score-box {
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        border: 1px solid var(--gold);
        font-family: monospace;
      }

      .leaderboard-item {
        padding: 8px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        gap: 20px;
      }
      .rank-1 {
        border-left: 4px solid gold;
      }
      .rank-2 {
        border-left: 4px solid silver;
      }
      .rank-3 {
        border-left: 4px solid #cd7f32;
      }
    </style>
  </head>
  <body>
    <div id="start-screen" class="screen">
      <h1 style="color: var(--gold); font-size: 3rem; margin-bottom: 10px">
        PRO SPEED QUIZ
        <!-- How to Play Section -->
        <div
          style="
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-width: 600px;
            border: 1px solid rgba(255, 215, 0, 0.3);
          "
        >
          <h3 style="color: var(--gold); margin-top: 0; margin-bottom: 10px">
            üìã HOW TO PLAY
          </h3>
          <div style="text-align: left; font-size: 0.95rem; line-height: 1.6">
            <p style="margin: 8px 0">‚úì Answer 25 CDL Air Brakes questions</p>
            <p style="margin: 8px 0">
              ‚úì Click the correct answer card before time runs out
            </p>
            <p style="margin: 8px 0">
              ‚úì <span style="color: var(--gold)">+10 points</span> for fast
              correct answers
            </p>
            <p style="margin: 8px 0">
              ‚úì <span style="color: var(--gold)">+5 points</span> for slow
              correct answers
            </p>
            <p style="margin: 8px 0">
              ‚úì <span style="color: #ff6b6b">-2 points</span> for wrong answers
            </p>
            <p style="margin: 8px 0">‚úì Beat the clock and compete globally!</p>
          </div>
        </div>
      </h1>
      <input
        type="text"
        id="username"
        placeholder="Driver Name"
        maxlength="15"
      />
      <div style="margin: 10px">
        <select
          id="time-limit"
          style="padding: 10px; border-radius: 5px; width: 200px"
        >
          <option value="10" selected>10s Limit (Standard)</option>
          <option value="5">5s Limit (Expert)</option>
        </select>
      </div>
      <button class="gold-btn" onclick="startGame()">DEAL CARDS</button>

      <div id="top-score-box">
        <div style="color: var(--gold); margin-bottom: 10px; font-size: 1.2rem">
          üèÜ GLOBAL LEADERBOARD üèÜ
        </div>
        <div id="best-display">Loading scores...</div>
      </div>
    </div>

    <div id="game-ui" class="hidden">
      <div id="game-header">
        <div class="stat-box">
          DRIVER: <span id="display-name" style="color: var(--gold)"></span>
        </div>
        <div class="stat-box">
          SCORE: <span id="score" style="color: var(--gold)">0</span>
        </div>
        <div class="stat-box">
          TOTAL TIME:
          <span id="total-time-text" style="color: var(--gold)">0</span>s
        </div>
        <div class="stat-box">Q: <span id="progress">1</span>/25</div>
      </div>

      <div id="timer-bar-container"><div id="timer-bar"></div></div>
      <div id="question-container"><div id="main-q" class="q-card"></div></div>
      <div id="answers-grid"></div>
    </div>

    <div id="results-screen" class="screen hidden">
      <h1 style="color: var(--gold); font-size: 3rem">FINISH LINE</h1>
      <div
        style="
          background: rgba(255, 255, 255, 0.1);
          padding: 25px;
          border-radius: 15px;
          border: 2px solid var(--gold);
        "
      >
        <h2 id="final-stats"></h2>
        <h3 id="final-time"></h3>
        <div
          id="new-record"
          style="color: var(--gold); font-weight: bold; margin: 10px 0"
        ></div>
      </div>
      <button class="gold-btn" onclick="location.reload()">RETAKE EXAM</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBxMj479t_FN2BqTouG5Afjg7c3LKUCb9E",
        authDomain: "fertech-7bc47.firebaseapp.com",
        projectId: "fertech-7bc47",
        storageBucket: "fertech-7bc47.firebasestorage.app",
        messagingSenderId: "564503522877",
        appId: "1:564503522877:web:0c46bdd549cf550996045e",
        measurementId: "G-72VL3NBP2F",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Game Variables
      const questions = [
        {
          q: "What are the 3 air brake systems?",
          a: "Service, Parking, and Emergency",
        },
        { q: "What is the governor cut-out pressure?", a: "125 psi" },
        { q: "What is the governor cut-in pressure?", a: "100 psi" },
        { q: "Low air warning must trigger by what PSI?", a: "60 psi" },
        { q: "At what PSI do spring brakes usually apply?", a: "20 - 45 psi" },
        { q: "Max leakage rate for a single vehicle?", a: "2 psi per minute" },
        {
          q: "Max leakage rate for a combination vehicle?",
          a: "3 psi per minute",
        },
        { q: "Safety valve is usually set to open at?", a: "150 psi" },
        { q: "The 'Treadle Valve' is also known as the...", a: "Brake Pedal" },
        { q: "Slack adjuster movement should not exceed...", a: "1 inch" },
        { q: "What holds spring brakes back when driving?", a: "Air Pressure" },
        { q: "How often should you drain manual air tanks?", a: "Daily" },
        { q: "Why drain air tanks regularly?", a: "Remove water and oil" },
        { q: "Most common foundation brake on trucks?", a: "S-cam Drum Brake" },
        {
          q: "What shows pressure in the storage tanks?",
          a: "Supply Pressure Gauge",
        },
        { q: "Dual air systems require what PSI to drive?", a: "100 psi" },
        { q: "What prevents ice in air lines?", a: "Alcohol Evaporator" },
        { q: "What pumps air into storage tanks?", a: "Air Compressor" },
        { q: "The 'Wig Wag' is a type of...", a: "Low air warning" },
        { q: "Brake lag adds how many feet at 55 mph?", a: "32 feet" },
        {
          q: "What happens when you 'fan' the brakes?",
          a: "Air pressure drops",
        },
        {
          q: "Total stopping distance includes...",
          a: "Perception + Reaction + Lag + Braking",
        },
        {
          q: "What is the purpose of a safety valve?",
          a: "Protect tanks from too much pressure",
        },
        {
          q: "A 'Modulating Valve' allows you to...",
          a: "Apply spring brakes gradually",
        },
        {
          q: "What happens if the compressor belt breaks?",
          a: "Air pressure will eventually drop",
        },
      ];

      let currentIdx = 0,
        score = 0,
        deck = [],
        lock = false;
      let turnStartTime,
        totalStartTime,
        ticker,
        timeLimit = 10;

      // Load Global Leaderboard on Page Load
      window.onload = () => {
        loadLeaderboard();
      };

      // Function to load and display top 10 scores from Firebase
      function loadLeaderboard() {
        db.collection("score")
          .orderBy("score", "desc")
          .limit(10)
          .get()
          .then((snapshot) => {
            const display = document.getElementById("best-display");
            if (snapshot.empty) {
              display.innerHTML =
                '<div style="color: #888;">No scores yet. Be the first!</div>';
              return;
            }

            let html = "";
            let rank = 1;
            snapshot.forEach((doc) => {
              const data = doc.data();
              const rankClass = rank <= 3 ? `rank-${rank}` : "";
              html += `
                        <div class="leaderboard-item ${rankClass}">
                            <span>${rank}. ${data.username}</span>
                            <span style="color: var(--gold)">${data.score} pts (${data.duration}s)</span>
                        </div>
                    `;
              rank++;
            });
            display.innerHTML = html;
          })
          .catch((error) => {
            console.error("Error loading leaderboard:", error);
            document.getElementById("best-display").innerHTML =
              '<div style="color: #888;">Error loading scores</div>';
          });
      }

      // Function to save score to Firebase
      function saveScoreToFirebase(username, finalScore, duration) {
        db.collection("score")
          .add({
            username: username,
            score: finalScore,
            duration: duration,
            time: firebase.firestore.FieldValue.serverTimestamp(),
          })
          .then(() => {
            console.log("Score saved to Firebase!");
          })
          .catch((error) => {
            console.error("Error saving score:", error);
          });
      }

      function startGame() {
        const nameInput = document.getElementById("username").value.trim();
        document.getElementById("display-name").innerText =
          nameInput || "Driver";
        timeLimit = parseInt(document.getElementById("time-limit").value);
        deck = [...questions].sort(() => Math.random() - 0.5);
        document.getElementById("start-screen").classList.add("hidden");
        document.getElementById("game-ui").classList.remove("hidden");
        totalStartTime = Date.now();
        loadNext();
      }

      function loadNext() {
        if (currentIdx >= deck.length) return endQuiz();
        lock = false;
        document.getElementById("progress").innerText = currentIdx + 1;
        const qData = deck[currentIdx];
        document.getElementById("main-q").innerText = qData.q;

        let options = [qData.a];
        let others = questions
          .map((q) => q.a)
          .filter((a) => a !== qData.a)
          .sort(() => Math.random() - 0.5)
          .slice(0, 4);
        options = [...options, ...others].sort(() => Math.random() - 0.5);

        const grid = document.getElementById("answers-grid");
        grid.innerHTML = "";
        options.forEach((opt) => {
          const btn = document.createElement("div");
          btn.className = "a-card";
          btn.innerText = opt;
          btn.onclick = () => check(opt, btn);
          grid.appendChild(btn);
        });

        turnStartTime = Date.now();
        clearInterval(ticker);
        ticker = setInterval(update, 50);
      }

      function update() {
        const turnElapsed = (Date.now() - turnStartTime) / 1000;
        const totalElapsed = (Date.now() - totalStartTime) / 1000;
        document.getElementById("total-time-text").innerText =
          Math.floor(totalElapsed);
        const remain = Math.max(0, 100 - (turnElapsed / timeLimit) * 100);
        document.getElementById("timer-bar").style.width = remain + "%";
      }

      function check(choice, el) {
        if (lock) return;
        if (choice === deck[currentIdx].a) {
          lock = true;
          clearInterval(ticker);
          el.classList.add("correct");
          const elapsed = (Date.now() - turnStartTime) / 1000;
          score += elapsed <= timeLimit ? 10 : 5;
          document.getElementById("score").innerText = score;
          setTimeout(() => {
            currentIdx++;
            loadNext();
          }, 1000);
        } else {
          el.classList.add("wrong");
          score -= 2;
          document.getElementById("score").innerText = score;
          setTimeout(() => el.classList.remove("wrong"), 600);
        }
      }

      function endQuiz() {
        clearInterval(ticker);
        const totalDuration = Math.floor((Date.now() - totalStartTime) / 1000);
        const playerName = document.getElementById("display-name").innerText;

        document.getElementById("game-ui").classList.add("hidden");
        document.getElementById("results-screen").classList.remove("hidden");
        document.getElementById("final-stats").innerText =
          `Final Score: ${score}`;
        document.getElementById("final-time").innerText =
          `Total Time: ${totalDuration} Seconds`;

        // Save score to Firebase
        saveScoreToFirebase(playerName, score, totalDuration);

        // Check if it's a personal best (local storage for comparison)
        const top = JSON.parse(localStorage.getItem("cdl_top_score"));
        if (
          !top ||
          score > top.score ||
          (score === top.score && totalDuration < top.duration)
        ) {
          localStorage.setItem(
            "cdl_top_score",
            JSON.stringify({
              name: playerName,
              score,
              duration: totalDuration,
            }),
          );
          document.getElementById("new-record").innerText =
            "‚òÖ PERSONAL BEST! Score saved to global leaderboard! ‚òÖ";
        } else {
          document.getElementById("new-record").innerText =
            "Score saved to global leaderboard!";
        }
      }
    </script>
  </body>
</html>
